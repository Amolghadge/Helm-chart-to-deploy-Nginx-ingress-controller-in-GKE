name: Deploy Nginx Ingress to GKE

on:
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - development
          - staging
          - production

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER_NAME: "gke-standard-cluster"
  GKE_ZONE: "us-central1-a"
  HELM_CHART_PATH: ./helm/nginx-ingress-controller
  NAMESPACE: ingress-nginx

jobs:
  lint-and-validate:
    name: Lint and Validate Helm Chart
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'

      - name: Add Helm repositories
        run: |
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo update

      - name: Lint Helm chart
        run: |
          helm dependency update ${{ env.HELM_CHART_PATH }}
          helm lint ${{ env.HELM_CHART_PATH }}
      - name: Template Helm chart
        run: |
          helm template nginx-ingress ${{ env.HELM_CHART_PATH }} \
            --namespace ${{ env.NAMESPACE }} \
            --debug
      - name: Install kubeconform for validation
        run: |
          wget https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/
      - name: Validate Kubernetes manifests
        run: |
          helm template nginx-ingress ${{ env.HELM_CHART_PATH }} \
            --namespace ${{ env.NAMESPACE }} | \
            kubeconform -strict -summary
  deploy-to-gke:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: lint-and-validate
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker
      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER_NAME }} \
            --zone ${{ env.GKE_ZONE }} \
            --project ${{ env.GCP_PROJECT_ID }}
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'

      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
      - name: Add Helm repositories (if using dependencies)
        run: |
          helm repo add stable https://charts.helm.sh/stable
          helm repo update
      - name: Deploy Helm chart
        run: |
          helm upgrade --install nginx-ingress ${{ env.HELM_CHART_PATH }} \
            --namespace ${{ env.NAMESPACE }} \
            --create-namespace \
            --wait \
            --timeout 10m \
            --atomic \
            --cleanup-on-fail \
            --values ${{ env.HELM_CHART_PATH }}/values.yaml
      - name: Verify deployment
        run: |
          kubectl rollout status deployment/nginx-ingress-nginx-ingress-controller \
            -n ${{ env.NAMESPACE }} \
            --timeout=5m
      - name: Get LoadBalancer IP
        id: get-lb-ip
        run: |
          echo "Waiting for LoadBalancer IP..."
          for i in {1..30}; do
            LB_IP=$(kubectl get svc nginx-ingress-nginx-ingress-controller \
              -n ${{ env.NAMESPACE }} \
              -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            
            if [ ! -z "$LB_IP" ]; then
              echo "LoadBalancer IP: $LB_IP"
              echo "lb_ip=$LB_IP" >> $GITHUB_OUTPUT
              break
            fi
            echo "Waiting for LoadBalancer IP... attempt $i/30"
            sleep 10
          done
      - name: Run deployment tests
        run: |
          kubectl get pods -n ${{ env.NAMESPACE }}
          kubectl get svc -n ${{ env.NAMESPACE }}
          kubectl describe deployment nginx-ingress-nginx-ingress-controller -n ${{ env.NAMESPACE }}
      - name: Post deployment summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Cluster**: ${{ env.GKE_CLUSTER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **LoadBalancer IP**: ${{ steps.get-lb-ip.outputs.lb_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Resources" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get all -n ${{ env.NAMESPACE }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy-to-gke
    if: failure()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER_NAME }} \
            --zone ${{ env.GKE_ZONE }} \
            --project ${{ env.GCP_PROJECT_ID }}
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'

      - name: Rollback Helm release
        run: |
          helm rollback nginx-ingress -n ${{ env.NAMESPACE }} || echo "No previous revision to rollback to"
      - name: Notify rollback
        run: |
          echo "## ⚠️ Deployment Failed - Rollback Initiated" >> $GITHUB_STEP_SUMMARY
          echo "The deployment failed and an automatic rollback was attempted." >> $GITHUB_STEP_SUMMARY